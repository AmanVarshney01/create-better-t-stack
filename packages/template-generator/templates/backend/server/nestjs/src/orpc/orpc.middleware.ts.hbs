import { Injectable, type NestMiddleware } from "@nestjs/common";
import { OpenAPIHandler } from "@orpc/openapi/node";
import { OpenAPIReferencePlugin } from "@orpc/openapi/plugins";
import { ZodToJsonSchemaConverter } from "@orpc/zod/zod4";
import { RPCHandler } from "@orpc/server/node";
import { onError } from "@orpc/server";
import { appRouter } from "@{{projectName}}/api/routers/index";
{{#if (eq auth "better-auth")}}
import { createContext } from "@{{projectName}}/api/context";
{{/if}}
import type { Request, Response, NextFunction } from "express";

@Injectable()
export class OrpcMiddleware implements NestMiddleware {
	private rpcHandler = new RPCHandler(appRouter, {
		interceptors: [
			onError((error) => {
				console.error(error);
			}),
		],
	});

	private apiHandler = new OpenAPIHandler(appRouter, {
		plugins: [
			new OpenAPIReferencePlugin({
				schemaConverters: [new ZodToJsonSchemaConverter()],
			}),
		],
		interceptors: [
			onError((error) => {
				console.error(error);
			}),
		],
	});

	async use(req: Request, res: Response, next: NextFunction) {
		const rpcResult = await this.rpcHandler.handle(req, res, {
			prefix: "/rpc",
{{#if (eq auth "better-auth")}}
			context: await createContext({ req }),
{{else}}
			context: {},
{{/if}}
		});
		if (rpcResult.matched) return;

		const apiResult = await this.apiHandler.handle(req, res, {
			prefix: "/api-reference",
{{#if (eq auth "better-auth")}}
			context: await createContext({ req }),
{{else}}
			context: {},
{{/if}}
		});
		if (apiResult.matched) return;

		next();
	}
}
