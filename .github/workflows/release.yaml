name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  id-token: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    name: Release to NPM
    if: startsWith(github.event.head_commit.message, 'chore(release):')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from commit message
        id: version
        run: |
          VERSION=$(echo "${{ github.event.head_commit.message }}" | sed -E 's/^chore\(release\): ([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid version format '$VERSION'. Expected semver (x.y.z)"
            exit 1
          fi

      - name: Check if version already exists
        id: check-version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if npm view create-better-t-stack@$VERSION version 2>/dev/null; then
            echo "Version $VERSION already exists on NPM"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Version $VERSION is new"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create and push tag
        if: steps.check-version.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git config --local user.email "amanvarshney.work@gmail.com"
          git config --local user.name "Aman Varshney"
          if ! git rev-parse "v$VERSION" >/dev/null 2>&1; then
            git tag -a "v$VERSION" -m "Release v$VERSION"
            git push --tags
          else
            echo "Tag v$VERSION already exists, skipping"
          fi

      - name: Setup Bun
        if: steps.check-version.outputs.exists == 'false'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Dependencies
        if: steps.check-version.outputs.exists == 'false'
        run: bun install --frozen-lockfile

      - name: Create GitHub Release
        if: steps.check-version.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! gh release view "v$VERSION" >/dev/null 2>&1; then
            bunx changelogithub
          else
            echo "Release v$VERSION already exists, skipping"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update types package version
        if: steps.check-version.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd packages/types
          jq --arg v "$VERSION" '.version = $v' package.json > tmp.json && mv tmp.json package.json

      - name: Build types package
        if: steps.check-version.outputs.exists == 'false'
        run: cd packages/types && bun run build

      - name: Publish types to NPM
        if: steps.check-version.outputs.exists == 'false'
        run: cd packages/types && bun publish --access public
        env:
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Update CLI version and types dependency
        if: steps.check-version.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd apps/cli
          jq --arg v "$VERSION" --arg dep "^$VERSION" '.version = $v | .dependencies["@better-t-stack/types"] = $dep' package.json > tmp.json && mv tmp.json package.json

      - name: Update CLI optionalDependencies versions
        if: steps.check-version.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd apps/cli
          jq --arg v "$VERSION" '
            .optionalDependencies["@better-t-stack/cli-darwin-arm64"] = $v |
            .optionalDependencies["@better-t-stack/cli-darwin-x64"] = $v |
            .optionalDependencies["@better-t-stack/cli-linux-arm64"] = $v |
            .optionalDependencies["@better-t-stack/cli-linux-x64"] = $v |
            .optionalDependencies["@better-t-stack/cli-windows-x64"] = $v
          ' package.json > tmp.json && mv tmp.json package.json

      - name: Build CLI binaries
        if: steps.check-version.outputs.exists == 'false'
        run: cd apps/cli && bun run build

      - name: Publish CLI platform packages to NPM
        if: steps.check-version.outputs.exists == 'false'
        run: |
          cd apps/cli/dist
          ls -la
          for dir in */; do
            if [ -f "$dir/package.json" ]; then
              echo "Publishing $dir..."
              cd "$dir"
              bun publish --access public
              cd ..
            fi
          done
        env:
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish CLI main package to NPM
        if: steps.check-version.outputs.exists == 'false'
        run: cd apps/cli && bun publish --access public
        env:
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Update create-bts alias package version
        if: steps.check-version.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd packages/create-bts
          jq --arg v "$VERSION" --arg dep "^$VERSION" '.version = $v | .dependencies["create-better-t-stack"] = $dep' package.json > tmp.json && mv tmp.json package.json

      - name: Publish create-bts alias to NPM
        if: steps.check-version.outputs.exists == 'false'
        run: cd packages/create-bts && bun publish --access public
        env:
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Upload binaries to GitHub Release
        if: steps.check-version.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cd apps/cli/dist
          for dir in better-t-stack-cli-*/; do
            name="${dir%/}"
            if [[ "$name" == *"linux"* ]]; then
              tar -czf "${name}.tar.gz" -C "$dir/bin" .
              gh release upload "v$VERSION" "${name}.tar.gz" --clobber
            else
              zip -j "${name}.zip" "$dir/bin/"*
              gh release upload "v$VERSION" "${name}.zip" --clobber
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        if: steps.check-version.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "## Release v$VERSION Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published Packages" >> $GITHUB_STEP_SUMMARY
          echo "- [create-better-t-stack@$VERSION](https://www.npmjs.com/package/create-better-t-stack/v/$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "- [create-bts@$VERSION](https://www.npmjs.com/package/create-bts/v/$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "- [@better-t-stack/types@$VERSION](https://www.npmjs.com/package/@better-t-stack/types/v/$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "- @better-t-stack/cli-darwin-arm64@$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- @better-t-stack/cli-darwin-x64@$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- @better-t-stack/cli-linux-arm64@$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- @better-t-stack/cli-linux-x64@$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- @better-t-stack/cli-windows-x64@$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### GitHub Release" >> $GITHUB_STEP_SUMMARY
          echo "[v$VERSION](https://github.com/${{ github.repository }}/releases/tag/v$VERSION)" >> $GITHUB_STEP_SUMMARY
