name: Upstream Gap Report

on:
  schedule:
    - cron: "0 9 * * 1"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  report:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Generate upstream gap report
        run: bun run scripts/upstream-gap-report.ts --markdown > upstream-gap-report.md

      - name: Publish workflow summary
        run: cat upstream-gap-report.md >> "$GITHUB_STEP_SUMMARY"

      - name: Open or update tracking issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("node:fs");
            const report = fs.readFileSync("upstream-gap-report.md", "utf8");
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const label = "upstream-sync";
            const title = "Upstream gap report (weekly)";
            const runUrl = `${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`;
            const body = `Automated upstream drift report.\n\n${report}\n\n_Generated by workflow run: ${runUrl}_`;

            try {
              await github.rest.issues.getLabel({ owner, repo, name: label });
            } catch {
              await github.rest.issues.createLabel({
                owner,
                repo,
                name: label,
                color: "0366d6",
                description: "Tracks upstream drift reports",
              });
            }

            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: "open",
              labels: label,
              per_page: 100,
            });

            const existing = issues.find((issue) => issue.title === title);

            if (existing) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: existing.number,
                body,
              });
            } else {
              await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
                labels: [label],
              });
            }
