name: Dependency Version Check

on:
  schedule:
    # Run every Monday at 9am UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:
    inputs:
      update_mode:
        description: "Update mode"
        type: choice
        options:
          - check-only
          - patch-minor
          - all
        default: "check-only"
      ecosystem:
        description: "Specific ecosystem to check (leave empty for all)"
        required: false
        type: string

concurrency:
  group: deps-check
  cancel-in-progress: true

jobs:
  check-versions:
    name: Check Dependency Versions
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Build Template Generator
        run: |
          cd packages/types && bun run build
          cd ../template-generator && bun run build

      - name: Run Version Check
        id: check
        run: |
          cd packages/template-generator

          # Scheduled runs should auto-open PRs with safe updates by default.
          EFFECTIVE_UPDATE_MODE="${{ inputs.update_mode }}"
          if [ -z "$EFFECTIVE_UPDATE_MODE" ]; then
            if [ "${{ github.event_name }}" = "schedule" ]; then
              EFFECTIVE_UPDATE_MODE="patch-minor"
            else
              EFFECTIVE_UPDATE_MODE="check-only"
            fi
          fi
          echo "effective_update_mode=$EFFECTIVE_UPDATE_MODE" >> "$GITHUB_OUTPUT"

          # Run the check script
          if [ -n "${{ inputs.ecosystem }}" ]; then
            bun run scripts/check-deps.ts --ecosystem "${{ inputs.ecosystem }}" > ../deps-report.md 2>&1 || true
          else
            bun run scripts/check-deps.ts > ../deps-report.md 2>&1 || true
          fi

          # Fallback if script output wasn't written for any reason.
          if ! grep -q "^has_updates=" "$GITHUB_OUTPUT"; then
            echo "has_updates=false" >> "$GITHUB_OUTPUT"
          fi

          # Store the report
          {
            echo 'report<<EOF'
            cat ../deps-report.md
            echo EOF
          } >> "$GITHUB_OUTPUT"

      - name: Display Report
        run: |
          echo "## Dependency Check Report"
          echo "${{ steps.check.outputs.report }}"

      - name: Apply Updates (if requested)
        if: steps.check.outputs.effective_update_mode == 'patch-minor' || steps.check.outputs.effective_update_mode == 'all'
        run: |
          cd packages/template-generator

          if [ "${{ steps.check.outputs.effective_update_mode }}" == "patch-minor" ]; then
            bun run scripts/check-deps.ts --apply-patch
          else
            bun run scripts/check-deps.ts --apply-all
          fi

      - name: Create Pull Request
        if: steps.check.outputs.has_updates == 'true' && (steps.check.outputs.effective_update_mode == 'patch-minor' || steps.check.outputs.effective_update_mode == 'all')
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update dependency versions"
          title: "chore(deps): Update dependency versions"
          body: |
            ## Dependency Version Updates

            This PR was automatically generated by the dependency version check workflow.

            ${{ steps.check.outputs.report }}

            ### Review Checklist
            - [ ] Review the version changes
            - [ ] Run `bun install` to update lockfile
            - [ ] Run tests to verify compatibility
            - [ ] Check for any breaking changes in major updates

            ---
            *Automated by [deps-check.yaml](.github/workflows/deps-check.yaml)*
          branch: deps/version-updates
          delete-branch: true
          labels: |
            dependencies
            automated

      - name: Post Summary
        run: |
          echo "## Dependency Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ steps.check.outputs.effective_update_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "**Has Updates:** ${{ steps.check.outputs.has_updates }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Report" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.check.outputs.report }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
